---
title: "Analysis"
format: html
---

# Load packages

```{r}
library(tidyverse)
library(here)
# library(tidylog) for coding feedback during development only
library(DescTools)
```

# Define summary function

```{r}
count_prop_ci <- function(data, ..., ci_method) {
  columns <- enquos(...)

  data_field <- data %>%
      filter(sample_id == "Field") %>%
      count(!!!columns, .drop = FALSE) 
  
  data_field <- data_field %>%
      cbind(MultinomCI(data_field$n, conf.level = 0.95, sides = "two.sided", method=ci_method)) %>%
      mutate(sample_id = "Field", N = sum(n))
    
  data_prom <- data %>%
      filter(sample_id == "Prominent") %>%
      count(!!!columns, .drop = FALSE) 
  
  data_prom <- data_prom %>%
      cbind(MultinomCI(data_prom$n, conf.level = 0.95, sides = "two.sided", method=ci_method)) %>%
      mutate(sample_id = "Prominent", N = sum(n))
  
  data_all <- bind_rows(data_field, data_prom) %>%
    select(sample_id, !!!columns, n, N, percent = est, ci_lwr = lwr.ci, ci_upr = upr.ci) %>%
    mutate(percent = percent*100, ci_lwr = ci_lwr*100, ci_upr = ci_upr*100, 
           report = paste0(n,' (',signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%])'))
  
  return(data_all)
}
```

# Load plot theme

```{r}
theme_custom <- function () { 
  theme_grey(base_size = 20, base_family = "sans") %+replace% 
    theme(
      # plot margin
      plot.margin = unit(rep(0.5, 4), "cm"),
      # plot background and border
      plot.background = element_blank(),
      panel.background = element_blank(),
      panel.border = element_blank(),
      # grid lines
      panel.grid.major.x = element_blank(),
      panel.grid.major.y = element_line(linewidth = 0.5, linetype = 'dotted', color = "#cbcbcb"), 
      panel.grid.minor = element_blank(),
      # axis ticks and lines
      axis.ticks = element_blank(),
      axis.line = element_blank(),
      # title, subtitle and caption
      #plot.title = element_text(size = 20, face = "bold", colour = "#757575", hjust = 0),
      # legend
      legend.position = "bottom",
      legend.margin = margin(0),
      legend.background = element_blank(),
      legend.key = element_blank(),
      legend.title = element_text(size = 12, colour = "#333333"),
      legend.text.align = 0,
      legend.text = element_text(size = 20, colour = "#333333"),
      # faceting
      strip.background = element_rect(fill = "transparent", colour = NA),
      strip.text = element_text(size = 20, face = "bold", colour = "#333333", hjust = 0, margin = margin(b = 10, t = 10))
    )
}
```

# Load custom functions

```{r}
# define a "not in" operator
`%notin%` <- Negate(`%in%`)

# function to calculate 95% Wilson CIs on single proportions (using prop.test) then output them in a string with a point estimate as percentages
percentCI <- function(successes, total) {
  percent <- round((successes/total)*100,1)
  CI <- round(prop.test(successes,total)$conf.int*100, 1)
  CIstring <- paste0(percent,'%, CI [', CI[1], ',', CI[2], ']')
  return(CIstring)
}
```

# Load data

```{r}
# load the extraction/classification data (output of the google form)
d <- read_csv(here('data','raw','Extraction form (Responses) - Form Responses 1.csv'))

# load article lists up until where data collection stopped
d_field_list <- read_csv(here('data','raw','field-wide-list - field-wide-list.csv')) %>% slice(1:226)
d_prominent_list <- read_csv(here('data','raw','prominent-list - prominent-list.csv')) %>% slice(1:234)
```

# Rename columns

```{r}
d <- d %>%
  rename(
    timestamp = Timestamp,
    coder_id = `Coder initials`,
    article_id = `Article ID`,
    open_access_status = `Can you view an open access version of this article?`,
    article_version_coded = `Which version of the article are you coding?`,
    eligible_empirical = `Does the article report on empirical data?`,
    research_design = `What is the research design? (tick all that apply)`,
    prereg_statement = `Does the article state whether or not the study (or some aspect of the study) was preregistered?`,
    prereg_statement_verbatim = `Copy and paste the verbatim statement`,
    prereg_identify_method = `How did you identify the statement?...10`,
    prereg_access_method = `How is the preregistration accessed? (according to the statement)`,
    prereg_access_status = `Can you access and view the preregistration (without contacting anyone)?`,
    data_statement = `Does the article state whether or not data are available?`,
    data_statement_verbatim = `Copy and paste the verbatim statement....14`,
    data_identify_method = `How did you identify the statement?...15`,
    data_access_method = `How are the data accessed? (according to the statement)`,
    data_access_status = `Can you access, download, and view the data (without contacting anyone)?`,
    materials_statement = `Does the article state whether or not materials are available?`,
    materials_statement_verbatim = `Copy and paste the verbatim statement....19`,
    materials_identify_method = `How did you identify the statement?...20`,
    materials_access_method = `How are the materials accessed? (according to the statement)`,
    materials_access_status = `Can you access, download, and view the materials (without contacting anyone)?`,
    analysis_statement = `Does the article state whether or not analysis scripts are available?`,
    analysis_statement_verbatim = `Copy and paste the verbatim statement....24`,
    analysis_identify_method = `How did you identify the statement?...25`,
    analysis_access_method = `How is the analysis script accessed? (according to the statement)`,
    analysis_access_status = `Can you access, download, and view the analysis script (without contacting anyone)?`,
    funding_statement = `Does the article include a statement indicating whether there were funding sources?`,
    funding_statement_verbatim = `Copy and paste the verbatim statement....29`,
    funding_identify_method = `How did you identify the statement?...30`,
    coi_statement = `Does the article include a statement indicating whether there were any conflicts of interest?`,
    coi_statement_verbatim = `Copy and paste the verbatim statement....32`,
    coi_identify_method = `How did you identify the statement?...33`,
    notes = `You can use this space to record anything interesting or problematic about this article`)
```

# Fix an encoding issue

```{r}
# there seems to be some encoding problem created by the use of em dashes so let's remove them

# Function to remove em dash
remove_em_dash <- function(x) {
  gsub("— ", "", x)
}

# Remove em dash from all columns
d <- mutate_all(d, ~remove_em_dash(.))
```

# Remove mistakenly coded articles

```{r}
# a few articles were mistakenly coded twice by a single coder. The extra article codings have the word 'exclude' in the coder id. Here we remove them.
d <- d %>% 
  filter(!str_detect(coder_id, "exclude"))
```

# Identify any articles in both samples

```{r}
# its plausible that articles appeared in both samples, which would mean they have four coders. We need to retain only the coding of two coders for each article.

# first identify any articles that are in both samples
articles_in_both_samples <- d_field_list %>% mutate(both_samples = article_id %in% d_prominent_list$article_id) %>% filter(both_samples == T) %>% pull(article_id)

# it looks like there is one such article
# remove two of the coders for this article
d <- d %>% filter(!(article_id == "75660" & coder_id %in% c("SC", "NM")))
```

# Identify article sample

```{r}
# the extraction/classification data in dataframe d is for both samples but does not identify to which sample each article belongs. To get this we need to compare the article ids to the lists of articles in each sample.

# identify article sample
d <- d %>% mutate(sample_id = case_when(
  article_id %in% d_field_list$article_id ~ 'Field',
  article_id %in% d_prominent_list$article_id ~ 'Prominent',
  TRUE ~ 'Neither'
  ))

# some articles were accidentally coded — coding was supposed to proceed row by row, but one coder started working further down the article list. These articles need to be excluded. Note above that when the article lists were loaded in above, we only loaded the rows up until data collection was stopped, so this does not include the articles that were incorrectly coded. Thus to remove the accidental coding from dataframe d, we just need to identify the articles that do not belong to either the field or prominent sample and remove them:
d <- d %>%
  filter(sample_id != 'Neither')
```

# Assign primary / secondary coder status

```{r}
# each article was coded by two independent coders, which we refer to as primary and secondary. There's no difference between the primary/secondary designation, but it will help us differentiate the two codings for each article as we mung the data.
d <- d %>%
  group_by(article_id) %>% # for each article
  mutate(coder_type = if_else(row_number() %% 2 == 1, "primary", "secondary")) %>% # first row = primary, second row = secondary 
  select(coder_type, everything()) %>%
  ungroup()
```

# Rearrange column order

```{r}
d <- d %>% 
  select(timestamp, article_id, sample_id, coder_type, coder_id, everything())
```

# Identify coding differences

```{r}
# we need to identify any differences between the primary and secondary coder so a third coder can reconcile them.

# get column names for which we want to compare primary and secondary coding
column_names <- d %>%
  select(-(timestamp:coder_id), -contains(c('verbatim', 'identify_method')), -article_version_coded, -notes) %>% 
  colnames()

# pivot dataframe so that there's one row per article and two columns (primary and secondary) for each variable (other than metadata)
d_wide <- d %>%
  select(-timestamp) %>%
  pivot_wider(
    id_cols = c(article_id, sample_id),
    names_from = coder_type,
    values_from = !c(article_id, sample_id, coder_type),
    names_sep = "_"
  ) 

# now we add a 'match' column for each variable which says whether the primary and secondary coding matched or not.
# we also add an 'agreed' column: if the coders agreed this contains the agreed coding. If they disagreed, this contains a ? until the third coder resolves the difference
for (i in seq_along(column_names)) {
  this_colname <- column_names[i]
  d_wide <- d_wide %>%
    mutate(!!paste0(this_colname, "_match") := if_else(!!sym(paste0(this_colname, "_primary")) == !!sym(paste0(this_colname, "_secondary")), T, F)) %>%
    mutate(!!paste0(this_colname, "_agreed") := if_else(!!sym(paste0(this_colname, "_match")) == T, !!sym(paste0(this_colname, "_primary")), '?'))
}

d_wide <- d_wide %>% 
  select("article_id", "sample_id", 
  "coder_id_primary", "coder_id_secondary", 
  "article_version_coded_primary", "article_version_coded_secondary", 
  "open_access_status_primary", "open_access_status_secondary", "open_access_status_match", "open_access_status_agreed", 
  "eligible_empirical_primary", "eligible_empirical_secondary", "eligible_empirical_match", "eligible_empirical_agreed", 
  "research_design_primary", "research_design_secondary", "research_design_match", "research_design_agreed", 
  "prereg_statement_primary", "prereg_statement_secondary", "prereg_statement_verbatim_primary", "prereg_statement_verbatim_secondary", "prereg_statement_match", "prereg_statement_agreed", "prereg_access_method_primary", "prereg_access_method_secondary", "prereg_access_method_match", "prereg_access_method_agreed", "prereg_access_status_primary", "prereg_access_status_secondary", "prereg_access_status_match", "prereg_access_status_agreed", "prereg_identify_method_primary", "prereg_identify_method_secondary", 
  "data_statement_primary", "data_statement_secondary", "data_statement_verbatim_primary", "data_statement_verbatim_secondary", "data_statement_match", "data_statement_agreed", "data_access_method_primary", "data_access_method_secondary", "data_access_method_match", "data_access_method_agreed", "data_access_status_primary", "data_access_status_secondary", "data_access_status_match", "data_access_status_agreed", "data_identify_method_primary", "data_identify_method_secondary", 
  "materials_statement_primary", "materials_statement_secondary", "materials_statement_verbatim_primary", "materials_statement_verbatim_secondary", "materials_statement_match", "materials_statement_agreed", "materials_access_method_primary", "materials_access_method_secondary", "materials_access_method_match", "materials_access_method_agreed", "materials_access_status_primary", "materials_access_status_secondary", "materials_access_status_match", "materials_access_status_agreed", "materials_identify_method_primary", "materials_identify_method_secondary", 
  "analysis_statement_primary", "analysis_statement_secondary", "analysis_statement_verbatim_primary", "analysis_statement_verbatim_secondary", "analysis_statement_match", "analysis_statement_agreed", "analysis_access_method_primary", "analysis_access_method_secondary", "analysis_access_method_match", "analysis_access_method_agreed", "analysis_access_status_primary", "analysis_access_status_secondary", "analysis_access_status_match", "analysis_access_status_agreed", "analysis_identify_method_primary", "analysis_identify_method_secondary", 
  "funding_statement_primary", "funding_statement_secondary", "funding_statement_verbatim_primary", "funding_statement_verbatim_secondary", "funding_statement_match", "funding_statement_agreed", "funding_identify_method_primary", "funding_identify_method_secondary", 
  "coi_statement_primary", "coi_statement_secondary", "coi_statement_verbatim_primary", "coi_statement_verbatim_secondary", "coi_statement_match", "coi_statement_agreed", "coi_identify_method_primary", "coi_identify_method_secondary", "notes_primary", "notes_secondary")
```

# Resolve coding differences 

```{r}
# firstly, if one coder found an open access version, that's sufficient to make that the agreed classification, so let's do that first:
d_wide <- d_wide %>%
  mutate(open_access_status_agreed = case_when(
    open_access_status_primary == "Yes" | open_access_status_secondary == "Yes" ~ "Yes",
    TRUE ~ open_access_status_agreed 
  ))

# second, let's find the cases where the primary and secondary coders did not agree on whether an article was empirical (and therefore eligible)
# NOT RUN d_wide %>% 
#   filter(eligible_empirical_primary != eligible_empirical_secondary)
# TEH will now check each of these manually and decide on the agreed upon classification, which will be added below.

d_wide <- d_wide %>%
  mutate(eligible_empirical_agreed = case_when(
    article_id == "71180" ~ "No",
    article_id == "33021" ~ "Yes",
    article_id == "120" ~  "Yes",
    article_id == "8710" ~  "No",
    article_id == "13823" ~ "Yes",
    article_id == "61098" ~ "No",
    article_id == "11240" ~ "No",
    article_id == "46814" ~ "No",
    article_id == "60074" ~ "No", 
    article_id == "38574" ~ "No",
    TRUE ~ eligible_empirical_agreed # for any other article id, retain whatever is already in this column
  ))

# check how many eligible articles in each sample (should be 200)
# d_wide %>% 
#   filter(eligible_empirical_agreed == "Yes") %>% count(sample_id)

# make a copy of the dataframe with only eligible articles for which there are coder disagreements to be resolved by a third coder

# Add a new column to check if any specified columns are FALSE
d_wide <- d_wide %>%
  rowwise() %>%
  mutate(any_disagreements = case_when(
    any(!across(ends_with("_statement_match"))) ~ TRUE,
    any(!across(ends_with("_access_method_match"))) ~ TRUE,
    any(!across(ends_with("_design_match"))) ~ TRUE, 
    any(!across(ends_with("access_status_match"))) ~ TRUE,
    TRUE ~ FALSE))

# prepare for output
d_wide_disagreements <- d_wide %>%
  arrange(desc(eligible_empirical_agreed), desc(any_disagreements))

# output dataframe with disagreements to be resolved manually
write_csv(d_wide_disagreements, here('data','primary','d_with_disagreements.csv'))

# load in dataframe with disagreements resolved manually, 
d <- read_csv(here('data','primary','d_with_disagreements_resolved.csv'))
```

```{r}
# calculate inter-rater agreement for statement variables
# prereg
prereg_ira <- d_wide_disagreements %>% filter(eligible_empirical_agreed == "Yes") %>% count(prereg_statement_match) %>% mutate(percent = (n/400)*100) %>% filter(prereg_statement_match == T) %>% pull(percent)

# materials
materials_ira <- d_wide_disagreements %>% filter(eligible_empirical_agreed == "Yes") %>% count(materials_statement_match) %>% mutate(percent = (n/400)*100) %>% filter(materials_statement_match == T) %>% pull(percent)

d_wide_disagreements %>% 
  filter(eligible_empirical_agreed == "Yes", materials_statement_match == F) %>%
  count(materials_statement_primary, materials_statement_secondary)

# data
data_ira <- d_wide_disagreements %>% filter(eligible_empirical_agreed == "Yes") %>% count(data_statement_match) %>% mutate(percent = (n/400)*100) %>% filter(data_statement_match == T) %>% pull(percent)

d_wide_disagreements %>% 
  filter(eligible_empirical_agreed == "Yes", data_statement_match == F) %>%
  count(data_statement_primary, data_statement_secondary)

# analysis scripts
analysis_ira <- d_wide_disagreements %>% filter(eligible_empirical_agreed == "Yes") %>% count(analysis_statement_match) %>% mutate(percent = (n/400)*100) %>% filter(analysis_statement_match == T) %>% pull(percent)

d_wide_disagreements %>% 
  filter(eligible_empirical_agreed == "Yes", analysis_statement_match == F) %>%
  count(analysis_statement_primary, analysis_statement_secondary)

# coi
coi_ira <- d_wide_disagreements %>% filter(eligible_empirical_agreed == "Yes") %>% count(coi_statement_match) %>% mutate(percent = (n/400)*100) %>% filter(coi_statement_match == T) %>% pull(percent)

# funding
funding_ira <- d_wide_disagreements %>% filter(eligible_empirical_agreed == "Yes") %>% count(funding_statement_match) %>% mutate(percent = (n/400)*100) %>% filter(funding_statement_match == T) %>% pull(percent)
```

```{r}
# select only agreed upon coding
d <- d %>% 
  select(article_id, sample_id, open_access_status_agreed, eligible_empirical_agreed, research_design_agreed, prereg_statement_verbatim_primary, prereg_statement_agreed, prereg_access_method_agreed, prereg_access_status_agreed, prereg_access_detail, data_statement_verbatim_primary, data_statement_agreed, data_reason, data_access_method_agreed, data_access_status_agreed, data_access_detail, materials_statement_verbatim_primary, materials_statement_agreed, materials_reason, materials_access_method_agreed, materials_access_status_agreed, materials_access_detail, analysis_statement_verbatim_primary, analysis_statement_agreed, analysis_reason, analysis_access_method_agreed, analysis_access_status_agreed, analysis_access_detail, funding_statement_verbatim_primary, funding_statement_agreed, coi_statement_verbatim_primary, coi_statement_agreed) %>% 
  rename_with(~ str_remove(., "_agreed"), ends_with("_agreed")) # remove the word agreed from the column name for more efficient coding
```

# Results

## Included articles

```{r}

field_total <- d %>% filter(sample_id == "Field") %>% nrow()
prom_total <- d %>% filter(sample_id == "Prominent") %>% nrow()

field_no_access <- d %>% 
  filter(open_access_status %in% c("No I cannot access any version of the article", "One coder cannot access any version of the article")) %>%
  count(sample_id) %>%
  pull(n)

not_empirical <- d %>% 
  filter(open_access_status %notin% c("No I cannot access any version of the article", "One coder cannot access any version of the article")) %>% # for articles we could access
  filter(eligible_empirical == "No") %>%
  count(sample_id)

field_not_empirical <- not_empirical %>% filter(sample_id == "Field") %>% pull(n)
prom_not_empirical <- not_empirical %>% filter(sample_id == "Prominent") %>% pull(n)

d_eligible <- d %>% 
  filter(open_access_status %notin% c("No I cannot access any version of the article", "One coder cannot access any version of the article")) %>% # for articles we could access
  filter(eligible_empirical == "Yes")
```

```{r}
research_design_field <- d_eligible %>% filter(sample_id == "Field") %>% count(sample_id, research_design) 
research_design_prom <- d_eligible %>% filter(sample_id == "Prominent") %>% count(sample_id, research_design) 

```

### Field-wide sample
In total, we examined `r field_total` articles from the field-wide list. `r field_no_access` articles were excluded because at least one coder could not access any version of them. `r field_not_empirical` additional articles were excluded because they were not empirical. `r field_total-field_no_access-field_not_empirical` eligible articles remained. Articles were classified as non-experimental (n = `r research_design_field %>% filter(research_design == "Non-experimental") %>% pull(n)`), experimental (n = `r research_design_field %>% filter(research_design == "Experimental") %>% pull(n)`), experimental and non-experimental (n = `r research_design_field %>% filter(research_design == "Experimental, Non-experimental") %>% pull(n)`), and meta-analysis (n = `r research_design_field %>% filter(research_design == "Meta-analysis") %>% pull(n)`). 

### Prominent sample
In total, we examined `r prom_total` articles from the prominent list. All articles could be accessed. `r prom_not_empirical` articles were excluded because they were not empirical. `r prom_total-prom_not_empirical` eligible articles remained. Articles were classified as non-experimental (n = `r research_design_prom %>% filter(research_design == "Non-experimental") %>% pull(n)`), experimental (n = `r research_design_prom %>% filter(research_design == "Experimental") %>% pull(n)`), experimental and non-experimental (n = `r research_design_prom %>% filter(research_design == "Experimental, Non-experimental") %>% pull(n)`), and meta-analysis (n = `r research_design_prom %>% filter(research_design == "Meta-analysis") %>% pull(n)`).

## Open access

```{r}
open_access_sum <- d_eligible %>%
  count_prop_ci(open_access_status, ci_method = "wilson")
```

### Field-wide sample
We identified an open access version for `r open_access_sum %>% filter(sample_id == "Field", open_access_status == "Yes") %>% pull(report)` articles (Figure 1). The remaining `r open_access_sum %>% filter(sample_id == "Field", open_access_status != "Yes") %>% pull(report)` articles were only accessible through a paywall.

### Prominent sample
We identified an open access version for `r open_access_sum %>% filter(sample_id == "Prominent", open_access_status == "Yes") %>% pull(report)` articles (Figure 1). The remaining `r open_access_sum %>% filter(sample_id == "Prominent", open_access_status != "Yes") %>% pull(report)` articles were only accessible through a paywall.

# Preregistration

## Statement
```{r}
prereg_statement_sum <- d_eligible %>%
  count_prop_ci(prereg_statement, ci_method = "sisonglaz")
```

## Functional preregistration

Occasionally a statement said there was a preregistration but we could not access it. So below we derive a prevalence estimate for *functional* preregistration i.e., articles that stated the research was preregistered and the preregistration could be accessed.

```{r}
prereg_functional_sum <- d_eligible %>%
  count_prop_ci(prereg_statement, prereg_access_status, ci_method = "sisonglaz")
```
## Access method
```{r}
prereg_access_sum <- d_eligible %>%
  filter(prereg_statement == "YES the statement says that there is a preregistration", prereg_access_status == "YES") %>%
  count(sample_id, prereg_access_method, .drop = F)
```
## Access failures
```{r}
prereg_access_detail_sum <- d_eligible %>%
  filter(prereg_access_status == "NO") %>%
  count(sample_id, prereg_access_detail, .drop = F)
```

## Table
```{r}
prereg_table <- bind_rows(
  prereg_statement_sum %>%
    select(prereg_statement, sample_id, report) %>%
    pivot_wider(id_cols = prereg_statement, names_from = sample_id, values_from = report) %>%
    mutate(prereg_access_status = NA, prereg_access_method = NA, prereg_access_detail = NA),

  prereg_functional_sum %>%
    filter(!is.na(prereg_access_status)) %>%
    select(prereg_statement, prereg_access_status, sample_id, report) %>%
    pivot_wider(id_cols = c(prereg_statement, prereg_access_status), names_from = sample_id, values_from = report) %>%
    mutate(prereg_access_method = NA, prereg_access_detail = NA),
  
  prereg_access_sum %>%
    mutate(prereg_statement = "YES the statement says that there is a preregistration", prereg_access_status = "YES") %>%
    select(prereg_statement, prereg_access_status, prereg_access_method, sample_id, report = n) %>%
    mutate(report = as.character(report)) %>%
    pivot_wider(id_cols = c(prereg_statement, prereg_access_status, prereg_access_method), names_from = sample_id, values_from = report) %>%
    mutate(prereg_access_detail = NA) %>%
    arrange(desc(as.numeric(Field)), desc(as.numeric(Prominent))),
  
  prereg_access_detail_sum %>% 
    mutate(prereg_statement = "YES the statement says that there is a preregistration", prereg_access_method = NA, prereg_access_status = "NO") %>%
    select(prereg_statement, prereg_access_status, prereg_access_method, prereg_access_detail, sample_id, report = n) %>%
    mutate(report = as.character(report)) %>%
    pivot_wider(id_cols = c(prereg_statement, prereg_access_status, prereg_access_method, prereg_access_detail), names_from = sample_id, values_from = report) %>%
    arrange(desc(as.numeric(Field)), desc(as.numeric(Prominent))),
  
  ) %>%
  mutate(prereg_statement = fct_na_value_to_level(prereg_statement, "NA"),
         prereg_statement = factor(prereg_statement, levels = 
                                     c("YES the statement says that there is a preregistration",
                                       "YES the statement says that there is no preregistration",
                                       "NO there is no statement about preregistration",
                                       "NA")),
         prereg_access_status = fct_na_value_to_level(prereg_access_status, "NA"),
         prereg_access_status = factor(prereg_access_status, levels = 
                                         c("NA", "YES", "NO"))) %>%
  select(prereg_statement, prereg_access_status, prereg_access_method, prereg_access_detail, Field, Prominent) %>%
  arrange(prereg_statement, prereg_access_status)
```

```{r}
knitr::kable(prereg_table)
```


# Materials

## Statement
```{r}
materials_statement_sum <- d_eligible %>%
  count_prop_ci(materials_statement, ci_method = "sisonglaz")
```

## Functional availability of materials

Occasionally a statement said that materials were available but we could not find or immediately access them. So below we derive a prevalence estimate for *functional* availability of materials i.e., articles that stated materials were available and we could in fact find and access materials.

```{r}
materials_functional_sum <- d_eligible %>%
  count_prop_ci(materials_statement, materials_access_status, ci_method = "sisonglaz")
```

## Access method
```{r}
materials_access_sum <-d_eligible %>%
  filter(materials_statement == "YES the statement says that the materials are available", materials_access_status == "YES") %>%
  count(sample_id, materials_statement, materials_access_status, materials_access_method, .drop = F)
```
## Access failures
```{r}
materials_access_detail_sum <- d_eligible %>%
  filter(materials_access_status == "NO") %>%
  count(sample_id, materials_access_detail, .drop = F)
```

## Reasons for not sharing
```{r}
materials_reasons_sum <- d_eligible %>%
  filter(materials_statement == "YES the statement says that the materials are not available") %>%
  count(sample_id, materials_reason, .drop = F)
```

## Table
```{r}
materials_table <- bind_rows(
  materials_statement_sum %>%
    select(materials_statement, sample_id, report) %>%
    pivot_wider(id_cols = materials_statement, names_from = sample_id, values_from = report) %>%
    mutate(materials_access_status = NA, materials_access_method = NA, materials_access_detail = NA, materials_reason = NA),

  materials_functional_sum %>%
    filter(!is.na(materials_access_status)) %>%
    select(materials_statement, materials_access_status, sample_id, report) %>%
    pivot_wider(id_cols = c(materials_statement, materials_access_status), names_from = sample_id, values_from = report) %>%
    mutate(materials_access_method = NA, mateials_access_detail = NA, materials_reason = NA),
  
  materials_access_sum %>%
    select(materials_statement, materials_access_status, materials_access_method, sample_id, report = n) %>%
    mutate(report = as.character(report)) %>%
    pivot_wider(id_cols = c(materials_statement, materials_access_status, materials_access_method), names_from = sample_id, values_from = report) %>%
    mutate(materials_access_detail = NA, materials_reason = NA) %>%
    arrange(desc(as.numeric(Field)), desc(as.numeric(Prominent))),
  
  materials_access_detail_sum %>% 
    mutate(materials_statement = "YES the statement says that the materials are available", materials_access_method = NA, materials_access_status = "NO") %>%
    select(materials_statement, materials_access_status, materials_access_method, materials_access_detail, sample_id, report = n) %>%
    mutate(report = as.character(report)) %>%
    pivot_wider(id_cols = c(materials_statement, materials_access_status, materials_access_method, materials_access_detail), names_from = sample_id, values_from = report) %>%
    mutate(materials_reason = NA) %>%
    arrange(desc(as.numeric(Field)), desc(as.numeric(Prominent))),
  
  materials_reasons_sum %>%
    mutate(materials_statement = "YES the statement says that the materials are not available", materials_access_method = NA, materials_access_detail = NA, materials_access_status = NA) %>%
    select(materials_statement, materials_access_status, materials_access_method, materials_access_detail, materials_reason, sample_id, report = n) %>%
    mutate(report = as.character(report)) %>%
    pivot_wider(id_cols = c(materials_statement, materials_access_status, materials_access_method, materials_access_detail, materials_reason), names_from = sample_id, values_from = report) %>%
    arrange(desc(as.numeric(Field)), desc(as.numeric(Prominent)))
  ) %>%
  mutate(materials_statement = fct_na_value_to_level(materials_statement, "NA"),
         materials_statement = factor(materials_statement, levels = 
                                     c("YES the statement says that the materials are available",
                                       "UNCLEAR a third party source is identified without any indication of availability",
                                       "YES the statement says that the materials are not available",
                                       "NO there is no materials availability statement",
                                       "NA")),
         materials_access_status = fct_na_value_to_level(materials_access_status, "NA"),
         materials_access_status = factor(materials_access_status, levels = 
                                         c("NA", "YES", "NO"))) %>%
  select(materials_statement, materials_access_status, materials_access_method, materials_access_detail, materials_reason, Field, Prominent) %>%
  arrange(materials_statement, materials_access_status)
```

```{r}
knitr::kable(materials_table)
```

# Data

## Statement
```{r}
data_statement_sum <- d_eligible %>%
  count_prop_ci(data_statement, ci_method = "sisonglaz")
```

## Functional availability of data

Occasionally a statement said that data were available but we could not find or immediately access them. So below we derive a prevalence estimate for *functional* availability of data i.e., articles that stated data were available and we could in fact find and access data.

```{r}
data_functional_sum <- d_eligible %>%
  count_prop_ci(data_statement, data_access_status, ci_method = "sisonglaz")
```

## Access method
```{r}
data_access_sum <- d_eligible %>%
  filter(data_statement == "YES the statement says that the data are available", data_access_status == "YES") %>%
  count(sample_id, data_statement, data_access_status, data_access_method, .drop = F)
```

## Access failures
```{r}
data_access_detail_sum <- d_eligible %>%
  filter(data_access_status == "NO") %>%
  count(sample_id, data_access_detail, .drop = F)
```
## Reasons for not sharing
```{r}
data_reasons_sum <- d_eligible %>%
  filter(data_statement == "YES the statement says that the data are not available") %>%
  count(sample_id, data_reason, .drop = F)
```

## Table
```{r}
data_table <- bind_rows(
  data_statement_sum %>%
    select(data_statement, sample_id, report) %>%
    pivot_wider(id_cols = data_statement, names_from = sample_id, values_from = report) %>%
    mutate(data_access_status = NA, data_access_method = NA, data_access_detail = NA, data_reason = NA),

  data_functional_sum %>%
    filter(!is.na(data_access_status)) %>%
    select(data_statement, data_access_status, sample_id, report) %>%
    pivot_wider(id_cols = c(data_statement, data_access_status), names_from = sample_id, values_from = report) %>%
    mutate(data_access_method = NA, mateials_access_detail = NA, data_reason = NA),
  
  data_access_sum %>%
    select(data_statement, data_access_status, data_access_method, sample_id, report = n) %>%
    mutate(report = as.character(report)) %>%
    pivot_wider(id_cols = c(data_statement, data_access_status, data_access_method), names_from = sample_id, values_from = report) %>%
    mutate(data_access_detail = NA, data_reason = NA) %>%
    arrange(desc(as.numeric(Field)), desc(as.numeric(Prominent))),
  
  data_access_detail_sum %>% 
    mutate(data_statement = "YES the statement says that the data are available", data_access_method = NA, data_access_status = "NO") %>%
    select(data_statement, data_access_status, data_access_method, data_access_detail, sample_id, report = n) %>%
    mutate(report = as.character(report)) %>%
    pivot_wider(id_cols = c(data_statement, data_access_status, data_access_method, data_access_detail), names_from = sample_id, values_from = report) %>%
    mutate(data_reason = NA) %>%
    arrange(desc(as.numeric(Field)), desc(as.numeric(Prominent))),
  
  data_reasons_sum %>%
    mutate(data_statement = "YES the statement says that the data are not available", data_access_method = NA, data_access_detail = NA, data_access_status = NA) %>%
    select(data_statement, data_access_status, data_access_method, data_access_detail, data_reason, sample_id, report = n) %>%
    mutate(report = as.character(report)) %>%
    pivot_wider(id_cols = c(data_statement, data_access_status, data_access_method, data_access_detail, data_reason), names_from = sample_id, values_from = report) %>%
    arrange(desc(as.numeric(Field)), desc(as.numeric(Prominent)))
  ) %>%
  mutate(data_statement = fct_na_value_to_level(data_statement, "NA"),
         data_statement = factor(data_statement, levels = 
                                     c("YES the statement says that the data are available",
                                       "UNCLEAR a third party source is identified without any indication of availability",
                                       "YES the statement says that the data are not available",
                                       "NO there is no data availability statement",
                                       "NA")),
         data_access_status = fct_na_value_to_level(data_access_status, "NA"),
         data_access_status = factor(data_access_status, levels = 
                                         c("NA", "YES", "NO"))) %>%
  select(data_statement, data_access_status, data_access_method, data_access_detail, data_reason, Field, Prominent) %>%
  arrange(data_statement, data_access_status)
```

```{r}
knitr::kable(data_table)
```

# Analysis script availability

## Statement
```{r}
analysis_statement_sum <- d_eligible %>%
  count_prop_ci(analysis_statement, ci_method = "sisonglaz")
```

## Functional availability of analysis scripts

Occasionally a statement said that analysis scripts were available but we could not find or immediately access them. So below we derive a prevalence estimate for *functional* availability of analysis scripts i.e., articles that stated analysis scripts were availabile and we could in fact find and access analysis scripts.

```{r}
analysis_functional_sum <- d_eligible %>%
  count_prop_ci(analysis_statement, analysis_access_status, ci_method = "sisonglaz")
```

## Access method
```{r}
analysis_access_sum <- d_eligible %>%
  filter(analysis_statement == "YES the statement says that the analysis scripts are available", analysis_access_status == "YES") %>%
  count(sample_id, analysis_statement, analysis_access_status, analysis_access_method, .drop = F)
```

## Access failures
```{r}
analysis_access_detail_sum <- d_eligible %>%
  filter(analysis_access_status == "NO") %>%
  count(sample_id, analysis_access_detail, .drop = F)
```

## Reasons for not sharing
```{r}
analysis_reasons_sum <- d_eligible %>%
  filter(analysis_statement == "YES the statement says that the analysis scripts are not available") %>%
  count(sample_id, analysis_reason, .drop = F)
```

## Table
```{r}
analysis_table <- bind_rows(
  analysis_statement_sum %>%
    select(analysis_statement, sample_id, report) %>%
    pivot_wider(id_cols = analysis_statement, names_from = sample_id, values_from = report) %>%
    mutate(analysis_access_status = NA, analysis_access_method = NA, analysis_access_detail = NA, analysis_reason = NA),

  analysis_functional_sum %>%
    filter(!is.na(analysis_access_status)) %>%
    select(analysis_statement, analysis_access_status, sample_id, report) %>%
    pivot_wider(id_cols = c(analysis_statement, analysis_access_status), names_from = sample_id, values_from = report) %>%
    mutate(analysis_access_method = NA, mateials_access_detail = NA, analysis_reason = NA),
  
  analysis_access_sum %>%
    select(analysis_statement, analysis_access_status, analysis_access_method, sample_id, report = n) %>%
    mutate(report = as.character(report)) %>%
    pivot_wider(id_cols = c(analysis_statement, analysis_access_status, analysis_access_method), names_from = sample_id, values_from = report) %>%
    mutate(analysis_access_detail = NA, analysis_reason = NA) %>%
    arrange(desc(as.numeric(Field)), desc(as.numeric(Prominent))),
  
  analysis_access_detail_sum %>% 
    mutate(analysis_statement = "YES the statement says that the analysis scripts are available", analysis_access_method = NA, analysis_access_status = "NO") %>%
    select(analysis_statement, analysis_access_status, analysis_access_method, analysis_access_detail, sample_id, report = n) %>%
    mutate(report = as.character(report)) %>%
    pivot_wider(id_cols = c(analysis_statement, analysis_access_status, analysis_access_method, analysis_access_detail), names_from = sample_id, values_from = report) %>%
    mutate(analysis_reason = NA) %>%
    arrange(desc(as.numeric(Field)), desc(as.numeric(Prominent))),
  
  analysis_reasons_sum %>%
    mutate(analysis_statement = "YES the statement says that the analysis scripts are not available", analysis_access_method = NA, analysis_access_detail = NA, analysis_access_status = NA) %>%
    select(analysis_statement, analysis_access_status, analysis_access_method, analysis_access_detail, analysis_reason, sample_id, report = n) %>%
    mutate(report = as.character(report)) %>%
    pivot_wider(id_cols = c(analysis_statement, analysis_access_status, analysis_access_method, analysis_access_detail, analysis_reason), names_from = sample_id, values_from = report) %>%
    arrange(desc(as.numeric(Field)), desc(as.numeric(Prominent)))
  ) %>%
  mutate(analysis_statement = fct_na_value_to_level(analysis_statement, "NA"),
         analysis_statement = factor(analysis_statement, levels = 
                                     c("YES the statement says that the analysis scripts are available",
                                       "UNCLEAR a third party source is identified without any indication of availability",
                                       "YES the statement says that the analysis scripts are not available",
                                       "NO there is no analysis script availability statement",
                                       "NA")),
         analysis_access_status = fct_na_value_to_level(analysis_access_status, "NA"),
         analysis_access_status = factor(analysis_access_status, levels = 
                                         c("NA", "YES", "NO"))) %>%
  select(analysis_statement, analysis_access_status, analysis_access_method, analysis_access_detail, analysis_reason, Field, Prominent) %>%
  arrange(analysis_statement, analysis_access_status)
```

```{r}
knitr::kable(analysis_table)
```

# Funding disclosures

## Statement
```{r}
funding_any_sum <- d_eligible %>%
  mutate(funding_statement = case_when(
    funding_statement %in% c("YES the statement discloses at least one source of funding","YES the statement says that there was no relevant funding") ~ "Yes", 
    funding_statement == "UNCLEAR" ~ "Unclear",
    funding_statement == "NO there is no funding statement" ~ "No")) %>%
  count_prop_ci(funding_statement, ci_method = "sisonglaz")

funding_detail_sum <- d_eligible %>%
  count_prop_ci(funding_statement, ci_method = "sisonglaz")
```

## Table

```{r}
funding_table <- bind_rows(
    funding_any_sum %>%
      filter(funding_statement != "No") %>%
      select(funding_statement, sample_id, report) %>%
      pivot_wider(id_cols = funding_statement, names_from = sample_id, values_from = report),
    funding_detail_sum %>%
      filter(funding_statement %notin% c("No there is no funding statement", "UNCLEAR")) %>%
      select(funding_statement, sample_id, report) %>%
      pivot_wider(id_cols = funding_statement, names_from = sample_id, values_from = report)
    ) %>%
  mutate(funding_statement = factor(funding_statement, levels = 
                                     c("Yes",
                                       "YES the statement discloses at least one source of funding",
                                       "YES the statement says that there was no relevant funding",
                                       "Unclear",
                                       "NO there is no funding statement"))) %>%
  arrange(funding_statement)
```

```{r}
knitr::kable(funding_table)
```

# Conflict of interest disclosures

## Statement
```{r}
coi_any_sum <- d_eligible %>%
  mutate(coi_statement = case_when(
    coi_statement %in% c("YES the statement discloses at least one conflict of interest","YES the statement says that there were no conflicts of interest") ~ "Yes", 
    coi_statement == "UNCLEAR" ~ "Unclear",
    coi_statement == "NO there is no conflict of interest statement" ~ "No")) %>%
  count_prop_ci(coi_statement, ci_method = "sisonglaz")

coi_detail_sum <- d_eligible %>%
  count_prop_ci(coi_statement, ci_method = "sisonglaz")
```

## Table

```{r}
coi_table <- bind_rows(
    coi_any_sum %>%
      filter(coi_statement != "No") %>%
      select(coi_statement, sample_id, report) %>%
      pivot_wider(id_cols = coi_statement, names_from = sample_id, values_from = report),
    coi_detail_sum %>%
      filter(coi_statement %notin% c("No there is no conflict of interest statement", "UNCLEAR")) %>%
      select(coi_statement, sample_id, report) %>%
      pivot_wider(id_cols = coi_statement, names_from = sample_id, values_from = report)
    ) %>%
  mutate(coi_statement = factor(coi_statement, levels = 
                                     c("Yes",
                                       "YES the statement discloses at least one conflict of interest",
                                       "YES the statement says that there were no conflicts of interest",
                                       "Unclear",
                                       "NO there is no conflict of interest statement"))) %>%
  arrange(coi_statement)
```

```{r}
knitr::kable(coi_table)
```

# Plots

```{r}
plot_data <- bind_rows(
  
  open_access_sum %>%
    filter(open_access_status == "Yes") %>%
    mutate(practice = "Open access", var = "open_access_statement", type = "statement") %>%
    select(sample_id, practice, var, type, n, percent, ci_lwr, ci_upr),
  
  prereg_statement_sum %>% 
    filter(prereg_statement == "YES the statement says that there is a preregistration") %>%
    mutate(practice = "Preregistration", var = "prereg_statement", type = "statement") %>%
    select(sample_id, practice, var, type, n, percent, ci_lwr, ci_upr),

  prereg_functional_sum %>% 
    filter(prereg_statement == "YES the statement says that there is a preregistration", prereg_access_status == "YES") %>%
    mutate(practice = "Preregistration", var = "prereg_functional", type = "functional") %>%
    select(sample_id, practice, var, type, n, percent, ci_lwr, ci_upr),
  
  materials_statement_sum %>% 
    filter(materials_statement == "YES the statement says that the materials are available") %>%
    mutate(practice = "Materials", var = "materials_statement", type = "statement") %>%
    select(sample_id, practice, var, type, n, percent, ci_lwr, ci_upr),
  
  materials_functional_sum %>% 
    filter(materials_statement == "YES the statement says that the materials are available", materials_access_status == "YES") %>%
    mutate(practice = "Materials", var = "materials_functional", type = "functional") %>%
    select(sample_id, practice, var, type, n, percent, ci_lwr, ci_upr),
  
  data_statement_sum %>% 
    filter(data_statement == "YES the statement says that the data are available") %>%
    mutate(practice = "Data", var = "data_statement", type = "statement") %>%
    select(sample_id, practice, var, type, n, percent, ci_lwr, ci_upr),
  
  data_functional_sum %>% 
    filter(data_statement == "YES the statement says that the data are available", data_access_status == "YES") %>%
    mutate(practice = "Data", var = "data_functional", type = "functional") %>%
    select(sample_id, practice, var, type, n, percent, ci_lwr, ci_upr),
  
  analysis_statement_sum %>% 
    filter(analysis_statement == "YES the statement says that the analysis scripts are available") %>%
    mutate(practice = "Analysis scripts", var = "analysis_statement", type = "statement") %>%
    select(sample_id, practice, var, type, n, percent, ci_lwr, ci_upr),
  
  analysis_functional_sum %>% 
    filter(analysis_statement == "YES the statement says that the analysis scripts are available", analysis_access_status == "YES") %>%
    mutate(practice = "Analysis scripts",var = "analysis_functional", type = "functional") %>%
    select(sample_id, practice, var, type, n, percent, ci_lwr, ci_upr),
  
  funding_any_sum %>%
    filter(funding_statement == "Yes") %>%
    mutate(practice = "Funding",var = "funding_statement_any", type = "statement") %>%
    select(sample_id, practice, var, type, n, percent, ci_lwr, ci_upr),
  
  coi_any_sum %>%
    filter(coi_statement == "Yes") %>%
    mutate(practice = "Conflict of interest",var = "coi_statement_any", type = "statement") %>%
    select(sample_id, practice, var, type, n, percent, ci_lwr, ci_upr)
) %>%
  mutate(N = 200,
         sample_label = ifelse(sample_id == "Field", paste0("Field\n2022"), paste0("Prominent\n2022")))
```
```{r}
d_2015 <- read_csv(here('data','primary','d_Hardwicke2022.csv')) %>%
  mutate(
    percent = percent*100,
    ci_lwr = ci_lwr*100,
    ci_upr = ci_upr*100,
    sample_label = paste0("Field\n2014-2017")
  )
```

```{r core_practices_plot, fig.path = "figs/", fig.width = unit(10,"cm"), fig.height = unit(8,"cm")}
plot_core <- plot_data %>%
  bind_rows(d_2015) %>%
  filter(practice %in% c("Preregistration","Materials","Data","Analysis scripts"),
         type == "functional") %>%
  mutate(practice = factor(practice, levels = c("Preregistration","Materials","Data","Analysis scripts")),
         type = factor(type),
         type = fct_recode(type, "Functionally available" = "functional")) %>%
  ggplot(aes(x = sample_label, y = percent)) +
  facet_wrap(. ~ practice) +
    geom_pointrange(position = position_dodge(width = .2), shape = 21, size = 1, colour = "#333333",
      aes(
        fill = type,
        ymin = ci_lwr,
        ymax = ci_upr),
      show.legend = F) +
    geom_text(
             aes(label = paste0(signif(percent,2),'%')),
             show.legend = FALSE,
             size = 6,
             nudge_x = .275,
            colour = '#333333') +
    xlab('Sample') + 
    ylab('Articles (%) with functional availability') +
    scale_y_continuous(limits = c(0,30), breaks = seq(0,30,10)) +
    scale_fill_manual(values = "#7AD389") +
    labs(fill = NULL) + # hide legend title
    theme_custom() +
    theme(panel.background = element_rect(fill = "ivory"))
```


```{r other_practices_plot, fig.path = "figs/", fig.width = unit(10,"cm"), fig.height = unit(6,"cm")}
plot_other <- plot_data %>%
  bind_rows(d_2015) %>%
  filter(practice %in% c("Open access", "Conflict of interest", "Funding"), var %in% c("open_access_statement", "funding_statement_any", "coi_statement_any")) %>%
  mutate(practice = factor(practice, levels = c("Open access", "Conflict of interest", "Funding")),
         practice = fct_recode(practice, "Conflict of interest\nstatement" = "Conflict of interest", "Funding\nstatement" = "Funding"),
         type = factor(type)) %>%
  ggplot(aes(x = sample_label, y = percent)) +
  facet_wrap(. ~ practice) +
    geom_pointrange(position = position_dodge(width = .2), shape = 21, size = 1, colour = "#333333",
      aes(
        fill = type,
        ymin = ci_lwr,
        ymax = ci_upr),
      show.legend = F) +
      geom_text(
             aes(label = paste0(signif(percent,2),'%')),
             show.legend = FALSE,
             size = 6,
             nudge_x = .32,
            colour = '#333333') +
    xlab('Sample') + 
    ylab('Articles (%)') +
    scale_y_continuous(limits = c(0,100), breaks = seq(0,100,25)) +
    scale_fill_manual(values = "#B47AD3") +
    labs(fill = NULL) + # hide legend title
    theme_custom() +
    theme(panel.background = element_rect(fill = "ivory"))
```

```{r fig_one, fig.path = "figs/", fig.width = unit(11.5,"cm"), fig.height = unit(14,"cm")}
library(cowplot)
plot_grid(plot_core,plot_other, nrow = 2, rel_heights = c(1.5,1))
```

# Abstract

```{r}
# prepare values for in-text reporting
oa_field <- open_access_sum %>% 
  filter(sample_id == "Field", open_access_status == "Yes") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)

oa_prom <- open_access_sum %>% 
  filter(sample_id == "Prominent", open_access_status == "Yes") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)

fund_field <- funding_any_sum %>% 
  filter(sample_id == "Field", funding_statement == "Yes") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)

fund_prom <- funding_any_sum %>% 
  filter(sample_id == "Prominent", funding_statement == "Yes") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)

coi_field <- coi_any_sum %>% 
  filter(sample_id == "Field", coi_statement == "Yes") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)

coi_prom <- coi_any_sum %>% 
  filter(sample_id == "Prominent", coi_statement == "Yes") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)

prereg_field <- prereg_functional_sum %>% 
  filter(sample_id == "Field", prereg_statement == "YES the statement says that there is a preregistration", prereg_access_status == "YES") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)

prereg_prom <- prereg_functional_sum %>% 
  filter(sample_id == "Prominent", prereg_statement == "YES the statement says that there is a preregistration", prereg_access_status == "YES") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)

materials_field <- materials_functional_sum %>% 
  filter(sample_id == "Field", materials_statement == "YES the statement says that the materials are available", materials_access_status == "YES") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)

materials_prom <- materials_functional_sum %>% 
  filter(sample_id == "Prominent", materials_statement == "YES the statement says that the materials are available", materials_access_status == "YES") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)

data_field <- data_functional_sum %>% 
  filter(sample_id == "Field", data_statement == "YES the statement says that the data are available", data_access_status == "YES") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)

data_prom <- data_functional_sum %>% 
  filter(sample_id == "Prominent", data_statement == "YES the statement says that the data are available", data_access_status == "YES") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)

analysis_field <- analysis_functional_sum %>% 
  filter(sample_id == "Field", analysis_statement == "YES the statement says that the analysis scripts are available", analysis_access_status == "YES") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)

analysis_prom <- analysis_functional_sum %>% 
  filter(sample_id == "Prominent", analysis_statement == "YES the statement says that the analysis scripts are available", analysis_access_status == "YES") %>% 
  mutate(abs_report = paste0(signif(percent,2),'% [',signif(ci_lwr,2),'%-',signif(ci_upr,2),'%]')) %>%
  pull(abs_report)
```

Over a decade of advocacy and policy reforms have attempted to increase the uptake of transparent research practices in the field of psychology; however, their collective impact is unclear. We estimated the prevalence of transparent research practices in (a) all psychology journals (i.e., field-wide); and (b) prominent psychology journals, by manually examining two random samples of 200 empirical articles (N = 400) published in 2022. Most articles had an open access version (field-wide: `r oa_field`; prominent: `r oa_prom`) and included a funding statement (field-wide: `r fund_field`; prominent: `r fund_prom`); or conflict of interest statement (field-wide: `r coi_field`; prominent: `r coi_prom`). Relatively few articles had a preregistration (field-wide: `r prereg_field`; prominent: `r prereg_prom`); materials (field-wide: `r materials_field`; prominent: `r materials_prom`); raw/primary data (field-wide: `r data_field`; prominent: `r data_prom`); or analysis scripts (field-wide: `r analysis_field`; prominent: `r analysis_prom`) that were immediately accessible without contacting authors or third parties. In conjunction with prior research (Hardwicke et al., 2022), our results suggest transparency increased moderately from 2017 to 2022. Overall, despite considerable infrastructure improvements, bottom-up advocacy, and top-down policy initiatives, transparency continues to be widely neglected in psychology.

# Confidence interval comparison

```{r}

# prereg
ci_prereg <- bind_rows(
  prereg_sison <- d_eligible %>%
    count_prop_ci(prereg_statement, ci_method = "sisonglaz") %>%
    mutate(method = "Sison-Glaz"),
  
  prereg_wilson <- d_eligible %>%
    count_prop_ci(prereg_statement, ci_method = "wilson") %>%
    mutate(method = "Wilson")
) %>%
  select(sample = sample_id, statement = prereg_statement, method, percent, ci_lwr, ci_upr) %>%
  mutate(percent = signif(percent,2), ci_lwr = signif(ci_lwr,2), ci_upr = signif(ci_upr,2)) %>%
  arrange(sample, statement, method)
 
# materials 
ci_materials <- bind_rows(
  materials_sison <- d_eligible %>%
    count_prop_ci(materials_statement, ci_method = "sisonglaz") %>%
    mutate(method = "Sison-Glaz"),
  
  materials_wilson <- d_eligible %>%
    count_prop_ci(materials_statement, ci_method = "wilson") %>%
    mutate(method = "Wilson")
) %>%
  select(sample = sample_id, statement = materials_statement, method, percent, ci_lwr, ci_upr) %>%
  mutate(percent = signif(percent,2), ci_lwr = signif(ci_lwr,2), ci_upr = signif(ci_upr,2)) %>%
  arrange(sample, statement, method)

# data
ci_data <- bind_rows(
  data_sison <- d_eligible %>%
    count_prop_ci(data_statement, ci_method = "sisonglaz") %>%
    mutate(method = "Sison-Glaz"),
  
  data_wilson <- d_eligible %>%
    count_prop_ci(data_statement, ci_method = "wilson") %>%
    mutate(method = "Wilson")
) %>%
  select(sample = sample_id, statement = data_statement, method, percent, ci_lwr, ci_upr) %>%
  mutate(percent = signif(percent,2), ci_lwr = signif(ci_lwr,2), ci_upr = signif(ci_upr,2)) %>%
  arrange(sample, statement, method)

# analysis
ci_analysis <- bind_rows(
  analysis_sison <- d_eligible %>%
    count_prop_ci(analysis_statement, ci_method = "sisonglaz") %>%
    mutate(method = "Sison-Glaz"),
  
  analysis_wilson <- d_eligible %>%
    count_prop_ci(analysis_statement, ci_method = "wilson") %>%
    mutate(method = "Wilson")
) %>%
  select(sample = sample_id, statement = analysis_statement, method, percent, ci_lwr, ci_upr) %>%
  mutate(percent = signif(percent,2), ci_lwr = signif(ci_lwr,2), ci_upr = signif(ci_upr,2)) %>%
  arrange(sample, statement, method)

# funding
ci_funding <- bind_rows(
  funding_sison <- d_eligible %>%
    count_prop_ci(funding_statement, ci_method = "sisonglaz") %>%
    mutate(method = "Sison-Glaz"),
  
  funding_wilson <- d_eligible %>%
    count_prop_ci(funding_statement, ci_method = "wilson") %>%
    mutate(method = "Wilson")
) %>%
  select(sample = sample_id, statement = funding_statement, method, percent, ci_lwr, ci_upr) %>%
  mutate(percent = signif(percent,2), ci_lwr = signif(ci_lwr,2), ci_upr = signif(ci_upr,2)) %>%
  arrange(sample, statement, method)

# conflicts of interest
ci_coi <- bind_rows(
  coi_sison <- d_eligible %>%
    count_prop_ci(coi_statement, ci_method = "sisonglaz") %>%
    mutate(method = "Sison-Glaz"),
  
  coi_wilson <- d_eligible %>%
    count_prop_ci(coi_statement, ci_method = "wilson") %>%
    mutate(method = "Wilson")
) %>%
  select(sample = sample_id, statement = coi_statement, method, percent, ci_lwr, ci_upr) %>%
  mutate(percent = signif(percent,2), ci_lwr = signif(ci_lwr,2), ci_upr = signif(ci_upr,2)) %>%
  arrange(sample, statement, method)

bind_rows(ci_prereg, ci_materials, ci_data, ci_analysis, ci_funding, ci_coi) %>%
  knitr::kable(digits = 1)
```

